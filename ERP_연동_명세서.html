<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP 연동 명세서 - QR 장비 추적 시스템</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.7;
            padding: 40px 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 50px;
        }
        h1 {
            text-align: center;
            color: #1a365d;
            font-size: 28px;
            margin-bottom: 10px;
            border-bottom: 3px solid #3182ce;
            padding-bottom: 20px;
        }
        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 40px;
        }
        h2 {
            color: #2d3748;
            font-size: 20px;
            margin: 40px 0 20px 0;
            padding-left: 15px;
            border-left: 4px solid #3182ce;
        }
        h3 {
            color: #4a5568;
            font-size: 16px;
            margin: 25px 0 15px 0;
        }

        /* 시스템 구성도 */
        .system-diagram {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        .system-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 25px 30px;
            border-radius: 10px;
            text-align: center;
            min-width: 160px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .system-box.erp {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .system-box.supabase {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .system-box .label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        .system-box .name {
            font-size: 18px;
            font-weight: bold;
        }
        .arrow {
            font-size: 24px;
            color: #a0aec0;
        }

        /* 플로우 차트 */
        .flow-section {
            background: #f8fafc;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
        }
        .flow-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 25px;
            position: relative;
        }
        .flow-step:last-child {
            margin-bottom: 0;
        }
        .flow-step::before {
            content: '';
            position: absolute;
            left: 24px;
            top: 50px;
            width: 2px;
            height: calc(100% + 5px);
            background: #e2e8f0;
        }
        .flow-step:last-child::before {
            display: none;
        }
        .step-number {
            width: 50px;
            height: 50px;
            background: #3182ce;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
            z-index: 1;
        }
        .step-content {
            margin-left: 20px;
            flex: 1;
        }
        .step-title {
            font-weight: bold;
            color: #2d3748;
            font-size: 16px;
            margin-bottom: 8px;
        }
        .step-desc {
            color: #718096;
            font-size: 14px;
        }
        .step-direction {
            display: inline-block;
            background: #edf2f7;
            color: #4a5568;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 8px;
        }

        /* 코드 블록 */
        .code-block {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 15px 0;
        }
        .code-block .comment {
            color: #68d391;
        }
        .code-block .keyword {
            color: #f6ad55;
        }
        .code-block .string {
            color: #fc8181;
        }

        /* 테이블 */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        th {
            background: #edf2f7;
            color: #2d3748;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        tr:hover {
            background: #f7fafc;
        }
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-read {
            background: #c6f6d5;
            color: #276749;
        }
        .badge-write {
            background: #fed7d7;
            color: #c53030;
        }
        .badge-required {
            background: #feebc8;
            color: #c05621;
        }

        /* 설정 항목 */
        .config-section {
            background: #fffaf0;
            border: 1px solid #fbd38d;
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
        }
        .config-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed #fbd38d;
        }
        .config-item:last-child {
            border-bottom: none;
        }
        .config-key {
            font-family: monospace;
            background: #2d3748;
            color: #fbd38d;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 13px;
            min-width: 200px;
        }
        .config-value {
            margin-left: 15px;
            color: #718096;
            font-size: 14px;
        }

        /* API 섹션 */
        .api-endpoint {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .api-method {
            display: inline-block;
            background: #48bb78;
            color: #fff;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
            margin-right: 10px;
        }
        .api-url {
            font-family: monospace;
            font-size: 16px;
            color: #276749;
        }

        /* 주의사항 */
        .notice {
            background: #ebf8ff;
            border-left: 4px solid #3182ce;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        .notice-title {
            font-weight: bold;
            color: #2b6cb0;
            margin-bottom: 10px;
        }
        .notice ul {
            margin-left: 20px;
            color: #4a5568;
        }
        .notice li {
            margin-bottom: 5px;
        }

        /* 푸터 */
        .footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
            color: #a0aec0;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ERP 연동 명세서</h1>
        <p class="subtitle">QR 장비 추적 시스템 - ERP 자동 동기화 가이드</p>

        <!-- 시스템 구성도 -->
        <h2>1. 시스템 구성</h2>
        <div class="system-diagram">
            <div class="system-box erp">
                <div class="label">사내 서버</div>
                <div class="name">ERP (MSSQL)</div>
            </div>
            <div class="arrow">→</div>
            <div class="system-box">
                <div class="label">Render 배포</div>
                <div class="name">Flask App</div>
            </div>
            <div class="arrow">→</div>
            <div class="system-box supabase">
                <div class="label">클라우드 DB</div>
                <div class="name">Supabase</div>
            </div>
        </div>

        <table>
            <tr>
                <th>시스템</th>
                <th>역할</th>
                <th>기술 스택</th>
            </tr>
            <tr>
                <td><strong>ERP</strong></td>
                <td>장비 원장 관리 (모델, 호기, 수주, 출하)</td>
                <td>MSSQL Server</td>
            </tr>
            <tr>
                <td><strong>Flask App</strong></td>
                <td>QR 생성, 동기화 처리, 웹 인터페이스</td>
                <td>Python Flask + pymssql</td>
            </tr>
            <tr>
                <td><strong>Supabase</strong></td>
                <td>QR 데이터, 장착 정보, 대시보드 데이터</td>
                <td>PostgreSQL (REST API)</td>
            </tr>
        </table>

        <!-- 데이터 흐름 -->
        <h2>2. 동기화 데이터 흐름</h2>

        <div class="flow-section">
            <div class="flow-step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <div class="step-direction">ERP → Flask</div>
                    <div class="step-title">미처리 장비 목록 조회</div>
                    <div class="step-desc">ERP에서 QR 링크가 없는 장비들을 가져옵니다.</div>
                    <div class="code-block">
<span class="keyword">SELECT</span> model, unit_number, order_number, shipment_date
<span class="keyword">FROM</span> [ERP 테이블]
<span class="keyword">WHERE</span> qr_link <span class="keyword">IS NULL OR</span> qr_link = <span class="string">''</span>
                    </div>
                </div>
            </div>

            <div class="flow-step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <div class="step-direction">Flask 내부 처리</div>
                    <div class="step-title">Access Token 생성</div>
                    <div class="step-desc">각 장비마다 32바이트 고유 토큰을 생성합니다.</div>
                    <div class="code-block">
access_token = secrets.token_urlsafe(32)
<span class="comment"># 예: "xK9mN2pQ7vR3wY6zA1bC4dE8fG0hJ5kL..."</span>
                    </div>
                </div>
            </div>

            <div class="flow-step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <div class="step-direction">Flask → Supabase</div>
                    <div class="step-title">장비 정보 등록</div>
                    <div class="step-desc">Supabase equipment 테이블에 새 레코드를 삽입합니다.</div>
                    <div class="code-block">
<span class="keyword">INSERT INTO</span> equipment (
    model, unit_number, order_number,
    shipment_date, access_token, qr_registered_date
) <span class="keyword">VALUES</span> (...)
                    </div>
                </div>
            </div>

            <div class="flow-step">
                <div class="step-number">4</div>
                <div class="step-content">
                    <div class="step-direction">Flask → ERP</div>
                    <div class="step-title">QR 링크 기록 (Write Back)</div>
                    <div class="step-desc">생성된 QR URL을 ERP에 다시 저장합니다.</div>
                    <div class="code-block">
<span class="keyword">UPDATE</span> [ERP 테이블]
<span class="keyword">SET</span> qr_link = <span class="string">'https://ssqr.onrender.com/scan/{token}'</span>
<span class="keyword">WHERE</span> model = ? <span class="keyword">AND</span> unit_number = ?
                    </div>
                </div>
            </div>
        </div>

        <!-- 데이터 매핑 -->
        <h2>3. ERP ↔ Supabase 데이터 매핑</h2>
        <table>
            <tr>
                <th>ERP 컬럼 (입력 필요)</th>
                <th>방향</th>
                <th>Supabase 컬럼</th>
                <th>설명</th>
            </tr>
            <tr>
                <td><code>model_col</code></td>
                <td><span class="badge badge-read">READ</span></td>
                <td>model</td>
                <td>장비 모델명</td>
            </tr>
            <tr>
                <td><code>unit_col</code></td>
                <td><span class="badge badge-read">READ</span></td>
                <td>unit_number</td>
                <td>호기번호</td>
            </tr>
            <tr>
                <td><code>order_col</code></td>
                <td><span class="badge badge-read">READ</span></td>
                <td>order_number</td>
                <td>수주번호</td>
            </tr>
            <tr>
                <td><code>shipment_col</code></td>
                <td><span class="badge badge-read">READ</span></td>
                <td>shipment_date</td>
                <td>출하일</td>
            </tr>
            <tr>
                <td><code>qr_link_col</code></td>
                <td><span class="badge badge-write">WRITE</span></td>
                <td>-</td>
                <td>생성된 QR URL 저장</td>
            </tr>
        </table>

        <!-- API 명세 -->
        <h2>4. API 호출 방법</h2>

        <div class="api-endpoint">
            <span class="api-method">POST</span>
            <span class="api-url">/api/sync_from_erp</span>
        </div>

        <h3>요청 헤더</h3>
        <div class="code-block">
Authorization: Bearer {SYNC_API_KEY}
Content-Type: application/json
        </div>

        <h3>응답 예시 (성공)</h3>
        <div class="code-block">
{
    <span class="string">"total"</span>: 15,      <span class="comment">// 조회된 총 장비 수</span>
    <span class="string">"created"</span>: 12,    <span class="comment">// 신규 등록</span>
    <span class="string">"skipped"</span>: 3,     <span class="comment">// 이미 존재하여 스킵</span>
    <span class="string">"failed"</span>: 0,      <span class="comment">// 실패</span>
    <span class="string">"errors"</span>: []      <span class="comment">// 에러 상세</span>
}
        </div>

        <h3>cURL 호출 예시</h3>
        <div class="code-block">
curl -X POST https://ssqr.onrender.com/api/sync_from_erp \
  -H "Authorization: Bearer YOUR_API_KEY_HERE" \
  -H "Content-Type: application/json"
        </div>

        <!-- 설정 항목 -->
        <h2>5. 설정 필요 항목</h2>

        <div class="config-section">
            <h3 style="margin-top:0; color:#c05621;">환경변수 (.env)</h3>
            <div class="config-item">
                <span class="config-key">ERP_DB_HOST</span>
                <span class="config-value">ERP MSSQL 서버 주소</span>
            </div>
            <div class="config-item">
                <span class="config-key">ERP_DB_PORT</span>
                <span class="config-value">포트 (기본값: 1433)</span>
            </div>
            <div class="config-item">
                <span class="config-key">ERP_DB_USER</span>
                <span class="config-value">DB 접속 계정</span>
            </div>
            <div class="config-item">
                <span class="config-key">ERP_DB_PASSWORD</span>
                <span class="config-value">DB 접속 비밀번호</span>
            </div>
            <div class="config-item">
                <span class="config-key">ERP_DB_NAME</span>
                <span class="config-value">데이터베이스 이름</span>
            </div>
            <div class="config-item">
                <span class="config-key">SYNC_API_KEY</span>
                <span class="config-value">API 인증 키 (랜덤 생성)</span>
            </div>
        </div>

        <div class="config-section">
            <h3 style="margin-top:0; color:#c05621;">쿼리 수정 (app.py 42~52행)</h3>
            <div class="config-item">
                <span class="config-key">erp_table</span>
                <span class="config-value">실제 ERP 테이블명</span>
            </div>
            <div class="config-item">
                <span class="config-key">model_col</span>
                <span class="config-value">모델명 컬럼</span>
            </div>
            <div class="config-item">
                <span class="config-key">unit_col</span>
                <span class="config-value">호기번호 컬럼</span>
            </div>
            <div class="config-item">
                <span class="config-key">order_col</span>
                <span class="config-value">수주번호 컬럼</span>
            </div>
            <div class="config-item">
                <span class="config-key">shipment_col</span>
                <span class="config-value">출하일 컬럼</span>
            </div>
            <div class="config-item">
                <span class="config-key">qr_link_col</span>
                <span class="config-value">QR 링크 저장 컬럼</span>
            </div>
        </div>

        <!-- 주의사항 -->
        <h2>6. 주의사항</h2>

        <div class="notice">
            <div class="notice-title">단방향 동기화</div>
            <ul>
                <li>ERP → Supabase로만 장비 정보가 전달됩니다.</li>
                <li>현장에서 입력한 장착일/딜러 정보는 Supabase에만 저장됩니다.</li>
                <li>장착 결과를 ERP로 역전송하는 기능은 현재 없습니다.</li>
            </ul>
        </div>

        <div class="notice">
            <div class="notice-title">중복 방지</div>
            <ul>
                <li><code>model + unit_number</code> 조합이 Supabase에 이미 있으면 스킵됩니다.</li>
                <li>같은 장비가 두 번 등록되지 않습니다.</li>
            </ul>
        </div>

        <div class="notice">
            <div class="notice-title">스케줄링 필요</div>
            <ul>
                <li>API는 호출 시에만 동기화를 수행합니다.</li>
                <li>주기적 자동 실행을 위해 외부 스케줄러(cron, Render Cron Job 등) 설정이 필요합니다.</li>
                <li>권장: 매일 1회 또는 출하 시점에 맞춰 실행</li>
            </ul>
        </div>

        <div class="footer">
            QR 장비 추적 시스템 &middot; SOOSAN CEBOTICS &middot; 2025
        </div>
    </div>
</body>
</html>
